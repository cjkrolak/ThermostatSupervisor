---
name: SonarQube Scan
# run this workflow when triggered by Azure DevOps pipeline completion
# or manually, or on pull requests to develop branch
on:
  repository_dispatch:
    types: [azure-pipeline-completed]
  workflow_dispatch:
    inputs:
      coverage_gist_id:
        description: Coverage gist ID (optional)
        required: false
        default: ''
  pull_request:
    branches: [develop]
jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    # Run if Azure pipeline was successful OR if manually triggered OR if PR to develop
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'repository_dispatch' &&
       github.event.client_payload.result == 'success')
    permissions:
      # Grant permissions needed for the action
      contents: read
      pull-requests: read
      checks: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          # Shallow clones should be disabled for better analysis relevancy
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Download coverage data from Azure DevOps
        id: Download_coverage_data_from_Azure_DevOps
        run: |
          echo "Starting coverage data download process..."
          echo "Event type: ${{ github.event_name }}"

          # Determine coverage gist ID from event payload or manual input
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            coverage_gist_id="${{ github.event.client_payload.coverage_gist_id }}"
            echo "Using coverage gist ID from repository dispatch: ${coverage_gist_id}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            coverage_gist_id="${{ github.event.inputs.coverage_gist_id }}"
            echo "Using coverage gist ID from manual input: ${coverage_gist_id}"
          else
            coverage_gist_id=""
            echo "No coverage gist ID available for event type:
            ${{ github.event_name }}"
          fi
          if [ -n "${coverage_gist_id}" ] && [ "${coverage_gist_id}" != "null" ] &&
             [ "${coverage_gist_id}" != "" ]; then
            echo "üì• Downloading coverage data from gist: ${coverage_gist_id}"

            # Download the gist content and extract coverage.xml directly
            echo "Fetching gist content..."
            curl -s -H "Authorization: token ${{ secrets.THERMOSTATSUPERVISOR_PR }}" \
            "https://api.github.com/gists/${coverage_gist_id}" > gist_response.json
            if [ $? -eq 0 ] && [ -s gist_response.json ]; then
              echo "Gist downloaded successfully, extracting coverage.xml..."
              python3 -c "if 1:
                              import json
                              import sys
                              try:
                                  with open('gist_response.json', 'r') as f:
                                      data = json.load(f)
                                      if 'files' in data and
                                         'coverage.xml' in data['files']:
                                          with open('coverage.xml', 'w') as f:
                                              f.write(data['files']['coverage.xml']
                                                  ['content'])
                                              print('‚úÖ Coverage data downloaded '
                                                    'successfully')
                                      else:
                                          print('‚ùå coverage.xml not found in gist')
                                          sys.exit(1)
                              except Exception as e:
                                  print(f'‚ùå Error processing gist: {e}')
                                  sys.exit(1)
              "

              # Cleanup: Delete the temporary gist (ignore errors)
              echo "Cleaning up temporary gist..."
              curl -s -X DELETE \
                -H "Authorization: token ${{ secrets.THERMOSTATSUPERVISOR_PR }}" \
                "https://api.github.com/gists/${coverage_gist_id}" > /dev/null 2>&1 ||
                echo "Note: Could not delete temporary gist"
              rm -f gist_response.json
            else
              echo "‚ùå Failed to download gist or gist is empty"
              echo "Falling back to generating coverage locally..."
              coverage_gist_id=""
            fi
          fi
        continue-on-error: true
        env:
          THERMOSTATSUPERVISOR_PR: ${{ secrets.THERMOSTATSUPERVISOR_PR }}
      - name: Regenerate Coverage Data since it does not exist
        if: |
          steps.Download_coverage_data_from_Azure_DevOps.outcome == 'success' &&
          (
            [ -z "${{
               steps.Download_coverage_data_from_Azure_DevOps.outputs.coverage_gist_id
            }}" ] ||
            [ "${{
               steps.Download_coverage_data_from_Azure_DevOps.outputs.coverage_gist_id
            }}" = "null" ] ||
            [ "${{
               steps.Download_coverage_data_from_Azure_DevOps.outputs.coverage_gist_id
            }}" = "" ] ||
            [ ! -f "coverage.xml" ]
          )
        run: |
          echo "‚ö†Ô∏è  No coverage gist ID provided or download failed,
          generating coverage data as fallback..."

          # Install dependencies
          echo "Installing dependencies..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt

          # Generate coverage
          echo "Running tests to generate coverage..."
          python -m tests.unit_test_coverage
          if [ ! -f "coverage.xml" ]; then
            echo "‚ùå Failed to generate coverage.xml"
            exit 1
          fi
        continue-on-error: true
        env:
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          TCC_USERNAME: ${{ secrets.TCC_USERNAME }}
          TCC_PASSWORD: ${{ secrets.TCC_PASSWORD }}
          SHT31_REMOTE_IP_ADDRESS_1: ${{ secrets.SHT31_REMOTE_IP_ADDRESS_1 }}
          KUMO_USERNAME: ${{ secrets.KUMO_USERNAME }}
          KUMO_PASSWORD: ${{ secrets.KUMO_PASSWORD }}
          BLINK_USERNAME: ${{ secrets.BLINK_USERNAME }}
          BLINK_PASSWORD: ${{ secrets.BLINK_PASSWORD }}
          BLINK_2FA: ${{ secrets.BLINK_2FA }}
      - name: Verify coverage file exists and validate content
        run: |
          echo "Verifying coverage file..."
          if [ -f "coverage.xml" ]; then
            echo "‚úÖ coverage.xml found"
            ls -la coverage.xml

            # Check file size
            file_size=$(wc -c < coverage.xml)
            echo "File size: ${file_size} bytes"
            if [ ${file_size} -eq 0 ]; then
              echo "‚ùå coverage.xml is empty"
              exit 1
            fi

            # Check if it's valid XML
            if python3 -c "if 1:
                               import xml.etree.ElementTree as ET
                               try:
                                   tree = ET.parse('coverage.xml')
                                   root = tree.getroot()
                                   print(f'‚úÖ Valid XML with root element: {root.tag}')

                                   # Check if it has coverage data
                                   if root.tag == 'coverage':
                                       lines_valid = root.get('lines-valid', '0')
                                       lines_covered = root.get('lines-covered', '0')
                                       print(f'Lines valid: {lines_valid}, '
                                             f'Lines covered: {lines_covered}')
                                       if int(lines_valid) > 0:
                                           print('‚úÖ Coverage data contains '
                                                 'valid metrics')
                                       else:
                                           print('‚ö†Ô∏è  Coverage data has no valid lines')
                                   else:
                                       print('‚ö†Ô∏è  Root element is not coverage')
                               except Exception as e:
                                   print(f'‚ùå Invalid XML: {e}')
                                   exit(1)
            "; then
              echo "Coverage file validation passed"
            else
              echo "‚ùå Coverage file validation failed"
              exit 1
            fi
            echo "First 10 lines of coverage.xml:"
            head -10 coverage.xml
          else
            echo "‚ùå coverage.xml not found"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
      - name: Debug information before SonarQube scan
        run: |
          echo "=== Debug Information ==="
          echo "Current working directory: $(pwd)"
          echo "Files in current directory:"
          ls -la
          echo "=== SonarQube Configuration ==="
          if [ -f "sonar-project.properties" ]; then
            echo "sonar-project.properties content:"
            cat sonar-project.properties
          else
            echo "‚ùå sonar-project.properties not found"
          fi
          echo "=== Coverage File Status ==="
          if [ -f "coverage.xml" ]; then
            echo "‚úÖ coverage.xml exists in working directory"
            echo "Absolute path: $(readlink -f coverage.xml)"
            echo "File size: $(wc -c < coverage.xml) bytes"
          else
            echo "‚ùå coverage.xml not found in working directory"
            echo "Searching for coverage files..."
            find . -name "*.xml" -type f | head -10
          fi
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
          GITHUB_TOKEN: ${{ secrets.THERMOSTATSUPERVISOR_PR }}

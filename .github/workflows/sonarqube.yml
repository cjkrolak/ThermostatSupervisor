---
name: SonarQube Scan

# run this workflow when triggered by Azure DevOps pipeline completion
"on":
  repository_dispatch:
    types: [azure-pipeline-completed]

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    # Only run if Azure pipeline was successful
    if: github.event.client_payload.result == 'success'
    permissions:
      # Grant permissions needed for the action
      contents: read
      pull-requests: read
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          # Shallow clones should be disabled for better analysis relevancy
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate code coverage
        run: |
          python -m tests.unit_test_coverage
        # Continue even if some tests fail, as coverage is still generated
        continue-on-error: true
        env:
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          TCC_USERNAME: ${{ secrets.TCC_USERNAME }}
          TCC_PASSWORD: ${{ secrets.TCC_PASSWORD }}
          SHT31_REMOTE_IP_ADDRESS_1: ${{ secrets.SHT31_REMOTE_IP_ADDRESS_1 }}
          KUMO_USERNAME: ${{ secrets.KUMO_USERNAME }}
          KUMO_PASSWORD: ${{ secrets.KUMO_PASSWORD }}
          BLINK_USERNAME: ${{ secrets.BLINK_USERNAME }}
          BLINK_PASSWORD: ${{ secrets.BLINK_PASSWORD }}
          BLINK_2FA: ${{ secrets.BLINK_2FA }}

      - name: Verify coverage file exists
        run: |
          if [ -f "coverage.xml" ]; then
            echo "✅ coverage.xml found"
            ls -la coverage.xml
            echo "First few lines of coverage.xml:"
            head -5 coverage.xml
          else
            echo "❌ coverage.xml not found"
            ls -la
            exit 1
          fi

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python
#
# SECRET MANAGEMENT STRATEGY:
# This GitHub Actions workflow uses GitHub secrets as the source of truth for all CI/CD secrets.
# This eliminates the need for secret duplication across multiple platforms.
#
# GitHub Secrets (Source of Truth):
# Location: GitHub repository > Settings > Secrets and variables > Actions
# Required secrets:
#   - GMAIL_USERNAME, GMAIL_PASSWORD (for email notification tests)
#   - TCC_USERNAME, TCC_PASSWORD (for Honeywell thermostat integration tests)  
#   - SHT31_REMOTE_IP_ADDRESS_1 (for SHT31 sensor tests)
#   - KUMO_USERNAME, KUMO_PASSWORD (for Kumo cloud integration tests)
#   - BLINK_USERNAME, BLINK_PASSWORD, BLINK_2FA (for Blink camera integration tests)
#   - THERMOSTATSUPERVISOR_PR (GitHub personal access token for API access)
#   - SONAR_TOKEN (SonarQube analysis token)
---
name: Python CI Pipeline

# disable CI trigger by default
on:
  # trigger on PR to dev branch only for relevant file changes
  pull_request:
    branches:
      - develop
    paths:
      - '**/*.py'
      - '.github/azure-pipelines.yml'
      - '.github/workflows/sonarqube.yml'
  # allow manual trigger
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # rem out 3.09 thru 3.12 to save CI time
        # python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
        python-version: ['3.13']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          # github token appears to enforce only supported python versions, ref #884
          # v3.13 is not supported by ubuntu-latest, once it is, the github token can be enabled.

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip list

      # line length and extend-ignore options added for compatibility with black
      - name: Run lint tests
        run: |
          python -m pip install flake8 --upgrade
          flake8 --config=setup.cfg .

      # python unit tests
      - name: Unit Tests
        run: |
          # python -m unittest discover -v
          # discover process is not allowing argv override so calling unit_test_common instead.
          python -m tests.unit_test_coverage
        # timeout after 30 minutes, nominal job time is 10 minutes
        timeout-minutes: 30
        env:
          # IMPORTANT: These GitHub secrets are the source of truth for all CI/CD secrets.
          # No need to maintain duplicates in other platforms.
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}  # used for some unit tests
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}  # used for some unit test
          TCC_USERNAME: ${{ secrets.TCC_USERNAME }}  # used for Honeywell int test
          TCC_PASSWORD: ${{ secrets.TCC_PASSWORD }}  # used for Honeywell int test
          SHT31_REMOTE_IP_ADDRESS_1: ${{ secrets.SHT31_REMOTE_IP_ADDRESS_1 }}
          # SHT31_REMOTE_IP_ADDRESS_99: ${{ secrets.SHT31_REMOTE_IP_ADDRESS_99 }}
          KUMO_USERNAME: ${{ secrets.KUMO_USERNAME }}  # used for kumocloud int test
          KUMO_PASSWORD: ${{ secrets.KUMO_PASSWORD }}  # used for kumocloud int test
          BLINK_USERNAME: ${{ secrets.BLINK_USERNAME }}  # used for blink int test
          BLINK_PASSWORD: ${{ secrets.BLINK_PASSWORD }}  # used for blink int test
          BLINK_2FA: ${{ secrets.BLINK_2FA }}  # used for blink int test

      # Upload coverage results
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      # Upload coverage.xml as GitHub artifact for SonarQube workflow
      - name: Upload Coverage Data
        run: |
          set -e
          echo "Uploading coverage.xml as GitHub artifact..."

          # Validate token and file exist
          if [ -z "${{ secrets.THERMOSTATSUPERVISOR_PR }}" ]; then
            echo "ERROR: THERMOSTATSUPERVISOR_PR is not set"
            exit 1
          fi

          if [ ! -f "coverage.xml" ]; then
            echo "ERROR: coverage.xml not found"
            exit 1
          fi

          echo "Coverage file size: $(wc -c < coverage.xml) bytes"

          # Create JSON payload using a temporary file to avoid command line length limits
          temp_json=$(mktemp)
          cat > "${temp_json}" << 'EOF'

          {
            "description": "Coverage data for SonarQube - Build BUILD_ID_PLACEHOLDER",
            "public": false,
            "files": {
              "coverage.xml": {
                "content": "CONTENT_PLACEHOLDER"
              }
            }
          }
          EOF

          # Replace placeholders with actual values
          # First replace BUILD_ID_PLACEHOLDER with actual build ID
          sed -i "s/BUILD_ID_PLACEHOLDER/${{ github.run_id }}/g" "${temp_json}"

          # Then replace CONTENT_PLACEHOLDER with properly escaped coverage.xml content
          # Use Python to properly escape JSON content to avoid shell quoting issues
          python3 -c "

          import json
          import sys

          # Read the coverage.xml content
          with open('coverage.xml', 'r') as f:
              coverage_content = f.read()

          # Read the JSON template
          with open('${temp_json}', 'r') as f:
              json_template = f.read()

          # Replace the content placeholder with properly escaped JSON string
          escaped_content = json.dumps(coverage_content)
          final_json = json_template.replace('\"CONTENT_PLACEHOLDER\"', escaped_content)

          # Write the final JSON
          with open('${temp_json}', 'w') as f:
              f.write(final_json)
          "

          # Create the GitHub gist using the JSON file
          response=$(curl -w "%{http_code}" -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.THERMOSTATSUPERVISOR_PR }}" \
            -H "User-Agent: GitHub-Actions-Pipeline" \
            -H "Content-Type: application/json" \
            https://api.github.com/gists \
            --data-binary "@${temp_json}")

          # Clean up temporary file
          rm -f "${temp_json}"

          # Extract HTTP status code and response body
          http_code="${response: -3}"
          response_body="${response%???}"

          if [[ ${http_code} -ge 200 && ${http_code} -lt 300 ]]; then
            # Extract gist ID from response
            gist_id=$(echo "${response_body}" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
            echo "‚úÖ Coverage uploaded successfully to gist: ${gist_id}"
            echo "coverage-gist-id=${gist_id}" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to upload coverage. HTTP ${http_code}"
            echo "Response: ${response_body}"
            exit 1
          fi
        continue-on-error: true
        id: upload-coverage
      # trigger SonarQube workflow on successful completion
      - name: Trigger SonarQube Workflow
        run: |
          set -e  # Exit on any error
          echo "Triggering SonarQube workflow..."

          # Validate token is present
          if [ -z "${{ secrets.THERMOSTATSUPERVISOR_PR }}" ]; then
            echo "ERROR: THERMOSTATSUPERVISOR_PR is not set"
            echo ""
            echo "üîß SETUP INSTRUCTIONS:"
            echo "1. Go to GitHub repository > Settings > Secrets and variables > Actions"
            echo "2. Set THERMOSTATSUPERVISOR_PR with a Personal Access Token (classic)"
            echo ""
            echo "Token scopes required:"
            echo "   - repo (for private repos) OR public_repo (for public repos)"
            echo "   - workflow (to trigger workflow dispatches)"
            echo ""
            echo "üîó Create token at: https://github.com/settings/tokens"
            exit 1
          fi

          echo "THERMOSTATSUPERVISOR_PR is configured (${#THERMOSTATSUPERVISOR_PR} characters)"

          # Test basic GitHub API access first
          echo "Testing GitHub API access..."
          test_response=$(curl -w "%{http_code}" -s -H "Authorization: token ${{ secrets.THERMOSTATSUPERVISOR_PR }}" https://api.github.com/user)
          test_code="${test_response: -3}"

          if [[ ${test_code} -ne 200 ]]; then
            echo "ERROR: GitHub API authentication failed (HTTP ${test_code})"
            echo "The THERMOSTATSUPERVISOR_PR is invalid or expired"
            echo ""
            echo "üîß TOKEN TROUBLESHOOTING:"
            echo "1. Verify the token at: https://github.com/settings/tokens"
            echo "2. Check if the token has expired"
            echo "3. Ensure the token has 'repo' and 'workflow' scopes"
            echo "4. The token must belong to a user with push access to the repository"
            exit 1
          fi

          echo "‚úÖ GitHub API authentication successful"

          # Get the coverage gist ID from previous step (if available)
          coverage_gist_id="${{ steps.upload-coverage.outputs.coverage-gist-id }}"
          echo "Coverage gist ID: ${coverage_gist_id}"

          # Make the API request with detailed error handling
          echo "Triggering repository dispatch event..."
          response=$(curl -w "%{http_code}" -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.THERMOSTATSUPERVISOR_PR }}" \
            -H "User-Agent: GitHub-Actions-Pipeline" \
            https://api.github.com/repos/cjkrolak/ThermostatSupervisor/dispatches \
            -d "{\"event_type\":\"azure-pipeline-completed\",\"client_payload\":{\"result\":\"success\",\"run_id\":\"${{ github.run_id }}\",\"coverage_gist_id\":\"${coverage_gist_id}\"}}")

          # Extract HTTP status code (last 3 characters)
          http_code="${response: -3}"
          response_body="${response%???}"

          echo "HTTP Response Code: ${http_code}"
          if [ -n "${response_body}" ]; then
            echo "Response Body: ${response_body}"
          fi

          # Check if the request was successful (2xx status codes)
          if [[ ${http_code} -ge 200 && ${http_code} -lt 300 ]]; then
            echo "‚úÖ Successfully triggered SonarQube workflow"
            exit 0
          elif [[ ${http_code} -eq 401 ]]; then
            echo "‚ùå ERROR: Authentication failed (HTTP 401)"
            echo ""
            echo "üîß TOKEN PERMISSIONS ISSUE:"
            echo "The THERMOSTATSUPERVISOR_PR lacks required permissions for workflow dispatches"
            echo ""
            echo "Required token scopes:"
            echo "  - repo (for private repositories)"
            echo "  - workflow (to trigger repository dispatch events)"
            echo ""
            echo "üîó Update token at: https://github.com/settings/tokens"
            echo "Response: ${response_body}"
            exit 1
          elif [[ ${http_code} -eq 403 ]]; then
            echo "‚ùå ERROR: Forbidden (HTTP 403)"
            echo "The token user lacks push access to the repository or token scopes insufficient"
            echo ""
            echo "Required:"
            echo "  - Token owner must have push access to cjkrolak/ThermostatSupervisor"
            echo "  - Token must have 'repo' and 'workflow' scopes"
            echo "Response: ${response_body}"
            exit 1
          elif [[ ${http_code} -eq 404 ]]; then
            echo "‚ùå ERROR: Repository not found (HTTP 404)"
            echo "Check repository name or ensure token has access to the repository"
            echo "Response: ${response_body}"
            exit 1
          else
            echo "‚ùå ERROR: Failed to trigger SonarQube workflow. HTTP ${http_code}"
            echo "Response: ${response_body}"
            exit 1
          fi
        if: success()
        env:
          THERMOSTATSUPERVISOR_PR: ${{ secrets.THERMOSTATSUPERVISOR_PR }}  # GitHub Personal Access Token

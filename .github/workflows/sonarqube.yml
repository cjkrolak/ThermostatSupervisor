name: SonarQube Scan

# run this workflow when triggered by Azure DevOps pipeline completion
on:
  repository_dispatch:
    types: [azure-pipeline-completed]
    
jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    # Only run if Azure pipeline was successful
    if: github.event.client_payload.result == 'success'
    permissions:
      # Grant permissions needed for the action
      contents: read
      pull-requests: read
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}